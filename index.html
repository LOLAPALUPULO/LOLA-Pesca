<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOLA Pesca - Tactical Ops</title>
    <script type="importmap">
{
  "imports": {
    "recharts": "https://aistudiocdn.com/recharts@^3.5.1",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.31.0",
    "react-dom": "https://aistudiocdn.com/react-dom@^19.2.1"
  }
}
</script>
    <style>
        /* --- FUENTE TACTICAL --- */
        @font-face {
            font-family: 'PitchedBattle';
            src: url('https://raw.githubusercontent.com/LOLAPALUPULO/LOLA-Pesca/main/Pitched%20Battle.ttf') format('truetype');
        }

        :root {
            --bg: #0b1120;
            --card: #1e293b;
            --text: #f1f5f9;
            --blue: #38bdf8;
            --green: #4ade80;
            --yellow: #facc15;
            --orange: #fb923c;
            --danger: #ef4444;
            --font-title: 'PitchedBattle', sans-serif;
            --font-default: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-default);
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 12px;
            padding-bottom: 120px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        /* --- LOGO --- */
        .brand-header {
            text-align: center;
            padding: 10px 0;
            display: flex;
            justify-content: center;
        }
        .brand-link { width: 60%; display: block; }
        .brand-logo {
            width: 100%; 
            height: auto;
            filter: drop-shadow(0 0 15px rgba(0,0,0,0.6));
        }

        /* --- CONTENEDORES --- */
        .card-box {
            background: var(--card);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            text-align: center;
            position: relative;
        }

        /* --- TEXTOS --- */
        .lbl { 
            font-family: var(--font-title); 
            color: #94a3b8; 
            font-size: 0.9rem; 
            margin-bottom: 5px; 
            letter-spacing: 1px; 
            text-transform: uppercase; 
        }
        
        .val { 
            font-size: 2.4rem; 
            font-weight: 900; 
            margin-top: 2px; 
            line-height: 1; 
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .sub-val { 
            font-size: 1rem; 
            color: #cbd5e1; 
            margin-top: 6px; 
            font-weight: 600;
        }

        .section-header { 
            text-align: center; color: var(--blue); font-family: var(--font-title); 
            margin: 30px 0 15px 0; font-size: 1.4rem; letter-spacing: 1px; 
            border-bottom: 2px solid #334155; padding-bottom: 8px;
        }
        
        /* HEADER UBICACI√ìN */
        .location-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 6px solid var(--blue);
            text-align: left;
            padding: 15px;
            background: #151e2e;
        }
        .loc-title { font-size: 1.4rem; color: white; margin-bottom: 2px; font-weight:bold; font-family: var(--font-title); }
        .loc-sub { font-size: 0.8rem; color: var(--green); }

        /* --- GRILLAS --- */
        /* Eliminamos .grid-2 y .grid-3 para dar m√°s control con clases espec√≠ficas */
        .grid-main-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        
        .data-box {
            background: var(--card);
            padding: 15px 5px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 110px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* Nuevos estilos para los cuadros de condiciones ambientales m√°s peque√±os y la grilla */
        .ambient-data-box {
            min-height: 65px; /* Altura m√≠nima reducida */
            padding: 8px 4px; /* Padding reducido */
        }
        .ambient-data-box .val {
            font-size: 1.8rem; /* Tama√±o de fuente m√°s peque√±o para el valor principal */
        }
        .ambient-data-box .lbl {
            font-size: 0.7rem; /* Tama√±o de fuente m√°s peque√±o para la etiqueta */
            margin-bottom: 1px;
        }
        .ambient-data-box .sub-val {
            font-size: 0.7rem; /* Tama√±o de fuente m√°s peque√±o para el sub-valor */
            margin-top: 2px;
        }

        /* Contenedor de la grilla para las condiciones ambientales */
        .ambient-grid-parent {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2 columnas en m√≥viles por defecto */
            gap: 10px;
            margin-bottom: 10px;
        }

        @media (min-width: 600px) {
            .ambient-grid-parent {
                grid-template-columns: repeat(4, 1fr); /* 4 columnas en pantallas m√°s anchas */
            }
        }

        /* --- BR√öJULA --- */
        .compass-container { cursor: pointer; } 
        .compass-rose {
            width: 70px; height: 70px; border-radius: 50%;
            background: #0f172a; border: 3px solid #475569;
            position: relative; box-shadow: inset 0 0 10px #000;
        }
        .cardinal { position: absolute; font-size: 0.75rem; font-weight: bold; color: #64748b; }
        .c-n { top: 2px; left: 50%; transform: translateX(-50%); color: var(--danger); }
        .c-e { right: 4px; top: 50%; transform: translateY(-50%); }
        .c-s { bottom: 2px; left: 50%; transform: translateX(-50%); }
        .c-o { left: 4px; top: 50%; transform: translateY(-50%); }

        .compass-needle {
            position: absolute; top: 50%; left: 50%;
            width: 8px; height: 50px;
            background: linear-gradient(to bottom, var(--danger) 50%, white 50%);
            transform: translate(-50%, -50%) rotate(0deg);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 5px rgba(0,0,0,0.8);
            z-index: 10;
        }
        
        /* --- RELOJ ANAL√ìGICO (NUEVOS ESTILOS) --- */
        .clock-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .analog-clock {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #0f172a;
            border: 3px solid #475569;
            position: relative;
            box-shadow: inset 0 0 10px #000;
        }

        .analog-clock::after { /* Center pivot dot */
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background-color: var(--blue);
            border-radius: 50%;
            z-index: 5;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .hour-mark {
            position: absolute;
            background-color: #64748b; /* Subtle gray for minor marks */
            z-index: 0; 
        }

        .mark-12 { top: 2px; left: 50%; transform: translateX(-50%); height: 7px; width: 2px; background-color: var(--text); }
        .mark-3 { right: 2px; top: 50%; transform: translateY(-50%); width: 7px; height: 2px; background-color: var(--text); }
        .mark-6 { bottom: 2px; left: 50%; transform: translateX(-50%); height: 7px; width: 2px; background-color: var(--text); }
        .mark-9 { left: 2px; top: 50%; transform: translateY(-50%); width: 7px; height: 2px; background-color: var(--text); }

        .hand {
            position: absolute;
            bottom: 50%; /* Center the pivot point vertically */
            left: 50%; /* Center the pivot point horizontally */
            transform-origin: bottom; /* Rotate from the bottom of the hand */
            transform: translateX(-50%) rotate(0deg); /* Center horizontally and initial rotation */
            border-radius: 2px;
            z-index: 1;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .hour-hand {
            width: 4px;
            height: 25px;
            background-color: var(--text);
            z-index: 3;
        }

        .minute-hand {
            width: 3px;
            height: 30px;
            background-color: var(--blue);
            z-index: 2;
        }

        .second-hand {
            width: 2px;
            height: 33px;
            background-color: var(--danger);
            z-index: 4;
            transition: transform 0.05s linear; /* Faster transition for smoother second hand */
        }
        /* --- FIN RELOJ ANAL√ìGICO --- */

        /* --- FASE LUNAR DENTRO DE DATA-BOX --- */
        .moon-phase-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 5px; /* Adjust padding for content */
            min-height: 110px;
        }
        .moon-phase-box #moon-icon {
            font-size: 3rem; /* Make icon larger */
            margin: 0;
            line-height: 1;
            margin-bottom: 5px; /* Space between icon and text */
        }
        .moon-phase-box #moon-phase {
            font-weight: bold;
            font-size: 1.1rem;
            color: white;
            text-transform: uppercase;
        }
        /* --- FIN FASE LUNAR DENTRO DE DATA-BOX --- */

        /* --- GUIA PECES --- */
        .guide-container { padding: 15px; }
        .tabs { display: flex; margin-bottom: 15px; border-bottom: 2px solid #334155; }
        .tab { 
            flex: 1; padding: 15px; text-align: center; background: none; border: none; 
            color: #64748b; font-size: 1.2rem; cursor: pointer; font-family: var(--font-title); 
        }
        .tab.active { color: var(--blue); border-bottom: 3px solid var(--blue); color: white; }
        
        select { 
            width: 100%; padding: 15px; background: #0f172a; border: 1px solid #334155; 
            color: white; border-radius: 8px; font-size: 1.2rem;
        }

        .fish-details { margin-top: 15px; display: none; padding: 15px; background: #111827; border-radius: 10px; border: 1px solid #374151; }
        .fish-details.show { display: block; animation: fadeIn 0.3s; }
        .detail-item { margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .detail-item:last-child { border: none; }

        /* --- TICKER ANIMATION (ESTRATEGIAS) --- */
        .ticker-wrap {
            width: 100%;
            overflow: hidden;
            background-color: #1e293b;
            padding-top: 12px;
            padding-bottom: 12px;
            white-space: nowrap;
            box-sizing: border-box;
            border-top: 1px solid #334155;
            border-bottom: 1px solid #334155;
            margin-bottom: 12px;
        }

        .ticker {
            display: inline-block;
            padding-left: 100%;
            animation: ticker-scroll 160s linear infinite;
            color: var(--yellow);
            font-family: var(--font-default); /* Tipograf√≠a default solicitada */
            font-size: 0.9rem; /* Texto m√°s chico solicitado */
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @keyframes ticker-scroll {
            0% { transform: translate3d(0, 0, 0); }
            100% { transform: translate3d(-100%, 0, 0); }
        }

        /* --- PREDICCION ESPECIES --- */
        .prediction-box { background: rgba(56, 189, 248, 0.1); border: 1px solid #334155; text-align: left; padding: 15px; display: none; }
        .species-list { font-size: 1.1rem; color: white; font-weight: 500; margin-top: 8px; line-height: 1.4; }
        .biome-tag { font-size: 0.9rem; background: var(--blue); color: #000; padding: 4px 8px; border-radius: 4px; font-weight: bold; }

        /* --- BOTONES --- */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px;}
        .btn-action {
            padding: 22px; border: none; border-radius: 12px; color: white;
            display: flex; align-items: center; justify-content: center; gap: 10px; 
            font-size: 1.2rem; cursor: pointer; font-family: var(--font-title);
            box-shadow: 0 4px 0 rgba(0,0,0,0.3); transition: transform 0.1s;
        }
        .btn-action:active { transform: translateY(4px); box-shadow: none; }
        .btn-torch { background: #475569; }
        .btn-torch.on { background: #f1f5f9; color: black; box-shadow: 0 0 20px white; }
        .btn-log { background: var(--green); color: #064e3b; }

        /* --- BITACORA --- */
        .log-container { margin-top: 30px; border-top: 2px solid #334155; padding-top: 15px; }
        .log-item {
            background: #1e293b; border-left: 5px solid var(--green);
            padding: 12px; margin-bottom: 10px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center; 
        }
        .log-text { font-size: 1rem; color: white; font-weight: bold; }
        .log-date { font-size: 0.85rem; color: #94a3b8; display: block; margin-top: 4px; }
        .btn-delete { background: #450a0a; border-radius: 6px; color: var(--danger); font-size: 1.3rem; width: 40px; height: 40px; border: none; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body>

    <!-- 1. LOGO CON ENLACE -->
    <div class="brand-header">
        <a href="https://www.instagram.com/lolapalupulo/" target="_blank" class="brand-link">
            <img src="https://raw.githubusercontent.com/LOLAPALUPULO/LOLA-Pesca/refs/heads/main/lolapesca.svg" alt="Lola Pesca" class="brand-logo">
        </a>
    </div>

    <!-- 2. UBICACI√ìN -->
    <div class="card-box location-bar">
        <div>
            <div class="loc-title" id="loc-name">üìç Buscando GPS...</div>
            <div class="loc-sub" id="gps-status">Estableciendo conexi√≥n...</div>
        </div>
        <button onclick="forceReload()" style="background:none; border:none; font-size:2rem; cursor:pointer;">üîÑ</button>
    </div>

    <!-- REORGANIZACI√ìN: Reloj / Br√∫jula / Temperatura -->
    <div class="grid-main-3">
        <!-- Reloj Anal√≥gico -->
        <div class="data-box" id="analog-clock-box">
            <span class="lbl">HORA ACTUAL</span>
            <div class="analog-clock" id="analog-clock">
                <div class="hour-mark mark-12"></div>
                <div class="hour-mark mark-3"></div>
                <div class="hour-mark mark-6"></div>
                <div class="hour-mark mark-9"></div>
                <div class="hand hour-hand" id="hour-hand"></div>
                <div class="hand minute-hand" id="minute-hand"></div>
                <div class="hand second-hand" id="second-hand"></div>
            </div>
            <div class="sub-val" style="font-weight:bold;">Local</div>
        </div>
        <!-- Br√∫jula (Movido) -->
        <div class="data-box compass-container" onclick="requestCompassPermission()">
            <div class="compass-rose">
                <span class="cardinal c-n">N</span>
                <span class="cardinal c-e">E</span>
                <span class="cardinal c-s">S</span>
                <span class="cardinal c-o">O</span>
                <div class="compass-needle" id="compass-needle"></div>
            </div>
            <div style="font-size:0.6rem; margin-top:8px; color:#888; font-weight:bold;">BR√öJULA</div>
        </div>
        <!-- Temperatura (Movido) -->
        <div class="data-box">
            <span class="lbl">TEMP</span>
            <span class="val" id="temp">--¬∞</span>
            <div class="sub-val" id="feels-like">ST: --¬∞</div>
        </div>
    </div>

    <!-- REORGANIZACI√ìN: Presi√≥n / Viento / Fase Lunar (Ex-Agua) -->
    <div class="grid-main-3">
        <!-- Presi√≥n HPA (Movido) -->
        <div class="data-box">
            <span class="lbl">PRESI√ìN (hPa)</span>
            <span class="val" id="press">--</span>
            <span class="sub-val" id="press-desc" style="font-weight:bold">Esperando..</span>
        </div>
        <!-- Viento (Movido) -->
        <div class="data-box">
            <span class="lbl">VIENTO</span>
            <span class="val" id="wind-speed">--</span>
            <div class="sub-val" id="wind-dir" style="color: var(--blue); font-weight:bold;">--</div>
        </div>
        <!-- Fase Lunar (Movido al lugar de 'Agua') -->
        <div class="data-box moon-phase-box">
            <span class="lbl">FASE LUNAR</span>
            <span id="moon-icon">üåë</span>
            <div id="moon-phase">--</div>
        </div>
    </div>
    
    <!-- La antigua secci√≥n de Fase Lunar (card-box) ha sido eliminada. -->

    <!-- NUEVA SECCI√ìN: CONDICIONES AMBIENTALES -->
    <div class="section-header">CONDICIONES AMBIENTALES</div>

    <div class="ambient-grid-parent">
        <!-- Humedad -->
        <div class="data-box ambient-data-box">
            <span class="lbl">HUMEDAD</span>
            <span class="val" id="humidity-val">--%</span>
            <span class="sub-val" style="font-weight:bold"></span>
        </div>
        <!-- Nubes -->
        <div class="data-box ambient-data-box">
            <span class="lbl">NUBES</span>
            <span class="val" id="clouds-val">--%</span>
            <span class="sub-val" style="font-weight:bold"></span>
        </div>
        <!-- Amanecer -->
        <div class="data-box ambient-data-box">
            <span class="lbl">AMANECER</span>
            <span class="val" id="sunrise-time">--:--</span>
            <span class="sub-val" style="font-weight:bold"></span>
        </div>
        <!-- Atardecer -->
        <div class="data-box ambient-data-box">
            <span class="lbl">ATARDECER</span>
            <span class="val" id="sunset-time">--:--</span>
            <span class="sub-val" style="font-weight:bold"></span>
        </div>
    </div>

    <!-- NUEVA SECCI√ìN: GR√ÅFICO DE PRESI√ìN -->
    <div id="pressure-chart-container"></div>
    
    <!-- 6. CONSULTAS -->
    <div class="section-header">ENCICLOPEDIA T√ÅCTICA</div>

    <!-- TICKER (TEXTO PASANTE) DE ESTRATEGIAS -->
    <div class="ticker-wrap">
        <div class="ticker">
            ‚ö†Ô∏è SIGILO: Evita ruidos en la costa ‚Ä¢ üå¨Ô∏è VIENTO: Pesca donde golpea la ola, ah√≠ est√° la comida ‚Ä¢ üî™ AFILA: Revisa el filo del anzuelo siempre ‚Ä¢ ü¶Ö OBSERVA: Si hay gaviotas tir√°ndose, hay cardumen ‚Ä¢ üåë LUNAS: Nueva y Llena mueven m√°s agua ‚Ä¢ üìâ PRESI√ìN: Si baja de golpe, el pique se corta ‚Ä¢ ‚öôÔ∏è FRENO: Regula la estrella antes de tirar ‚Ä¢ ü™µ ESTRUCTURA: Busca palos y piedras, ah√≠ acecha el predador ‚Ä¢ü©∏ SANGRE: Cebo fresco es clave ‚Ä¢ üßµ NYLON: Revisa los √∫ltimos metros, si est√° rasposo cort√° ‚Ä¢ üêü DEVOLUCI√ìN: Cuid√° el recurso ‚Ä¢ üåä REPUNTE: El mejor momento es el cambio de marea ‚Ä¢ üßº LIMPIEZA: El pez huele el tabaco y combustible en tus manos.
        </div>
    </div>
    
    <div class="card-box prediction-box" id="bio-box">
        <span class="biome-tag" id="bio-region">ZONA...</span>
        <div class="lbl" style="margin-top:10px;">ESPECIES PREDOMINANTES:</div>
        <div class="species-list" id="bio-species">--</div>
    </div>

    <div class="card-box guide-container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('rio')">R√çO</button>
            <button class="tab" onclick="switchTab('mar')">MAR</button>
        </div>
        <select id="fish-selector" onchange="showFishInfo()">
            <!-- JS -->
        </select>
        <div id="fish-info" class="fish-details">
            <div class="detail-item">
                <div class="lbl">ANZUELO RECOMENDADO</div>
                <div id="fish-hook" style="font-size:1.2rem; color:var(--blue); font-weight:bold;">--</div>
            </div>
            <div class="detail-item">
                <div class="lbl">MEJOR CARNADA</div>
                <div id="fish-bait" style="font-size:1.2rem;">--</div>
            </div>
            <div class="detail-item">
                <div class="lbl">INTELIGENCIA T√ÅCTICA</div>
                <div id="fish-tip" style="font-size:1.1rem; color:var(--orange); font-style:italic; line-height: 1.4;">--</div>
            </div>
        </div>
    </div>

    <!-- 7. HERRAMIENTAS -->
    <div class="action-grid">
        <button id="btn-torch" class="btn-action btn-torch" onclick="toggleFlash()">
            üí° LINTERNA
        </button>
        <button class="btn-action btn-log" onclick="saveQuickLog()">
            üìù BIT√ÅCORA
        </button>
    </div>

    <div id="log-history" class="log-container">
        <div style="text-align:center; color:#666; font-size:1rem; padding:10px;">Sin historial</div>
    </div>
    
    <!-- Punto de montaje para la l√≥gica de React (oculto) -->
    <div id="react-root-dummy" style="display: none;"></div>

    <script>
        // --- CONFIG & DB AMPLIADA ---
        const fishDB = {
            rio: [
                {n:"Dorado", h:"5/0 a 8/0 Pata Larga", b:"Anguila, Morena, Sabalito", t:"Usa l√≠der de acero 40lbs MINIMO. Busca correderas y palos sumergidos. El dorado caza por vibraci√≥n y destello."},
                {n:"Surub√≠", h:"8/0 a 10/0 Ojal", b:"Morena grande, Anguila, Cascarudo", t:"Actividad nocturna. Busca veriles profundos y salidas de arroyos. Dejar comer antes de clavar."},
                {n:"Boga", h:"Simple chico (1 o 2) Pata Corta", b:"Ma√≠z fermentado, Masa, Salam√≠n, Coraz√≥n", t:"Boca muy dura pero pique sutil. Clava firme cuando corre la l√≠nea. Ceba la zona previamente."},
                {n:"Pejerrey (R√≠o)", h:"Peque√±o (4 o 5)", b:"Mojarra viva, Filet de dientudo", t:"Pesca a flote con boyas. Fundamental regular la profundidad (brazolada) seg√∫n la temperatura."},
                {n:"Tararira", h:"Offset para goma / Triple", b:"Rana de goma, Dientudo fresco", t:"Se activa con calor. Busca zonas bajas con vegetaci√≥n/juncos. Ataca por irritaci√≥n o hambre."},
                {n:"Bagre (Moncholo/Amarillo)", h:"3/0 Com√∫n", b:"Lombriz de tierra, Tripa de pollo", t:"Pez de fondo. Busca remansos donde el agua gira lento. Ideal para principiantes o pesca variada."},
                {n:"Pac√∫", h:"Corto y fuerte (Mustad 92611)", b:"Bolitas de masa, Fruta (Aguai), Coquitos", t:"Pica muy suave, como si robara la carnada. Pescar bajo √°rboles o camalotes."},
                {n:"Pat√≠", h:"8/0 a 10/0", b:"Anguila podrida, Tripa, Filet de S√°balo", t:"Prefiere aguas profundas y correntosas. Caza por olfato, usa carnada con olor fuerte."},
                {n:"Manguruy√∫", h:"12/0 Reforzado", b:"Anguila entera, boga viva chica", t:"El gigante del fondo. Equipo pesado exclusivo. Busca los pozos m√°s profundos del cauce."}
            ],
            mar: [
                {n:"Corvina Rubia", h:"3/0 a 5/0", b:"Langostino, Anchoa, Almeja", t:"Lanza a la 2da canaleta. Come succionando el fondo. Si hay cangrejo, ata la carnada con hilo el√°stico."},
                {n:"Corvina Negra", h:"6/0 a 8/0 Reforzado", b:"Cangrejo vivo (colorado/negro)", t:"Busca fondos de piedra o barro en r√≠as (San Clemente/Mar Chiquita). Paciencia extrema."},
                {n:"Lenguado", h:"Triple robador + Simple", b:"Pejerrey entero fresco", t:"Pesca din√°mica (spinning/trolling). Recogida muy lenta arrastrando por el fondo de arena."},
                {n:"Pescadilla", h:"2/0 a 3/0", b:"Camar√≥n, Filet de pejerrey", t:"Pica firme y voraz. Usa l√≠nea con destrabe o 'bait clip' para ganar distancia."},
                {n:"Pejerrey (Mar)", h:"Largo y fino (Cornalera)", b:"Camar√≥n, Filet magru, Mondongo", t:"L√≠nea de 3 boyas o paternoster. Busca la espuma de la ola (rompiente) o muelles."},
                {n:"Chucho / Raya", h:"6/0 a 8/0 Fuerte", b:"Anchoa entera, Calamar", t:"Se 'chupa' al fondo. No fuerces la ca√±a, manten√© tensi√≥n hasta que se mueva. Cuidado con la p√∫a."},
                {n:"Burriqueta", h:"N3 o N4 Fino", b:"Lombriz de mar, Camar√≥n", t:"Excelente pesca familiar. Se encuentra en la primer canaleta, muy cerca de la orilla."},
                {n:"Pez Elefante", h:"2/0 a 3/0", b:"Anchoa fresca, Lombriz de mar", t:"Pique sutil. Temporada invernal o primavera. Busca pozos de arena limpia."}
            ]
        };

        let currentMode = 'rio';
        let torchTrack = null;
        let dataRefreshInterval = null; // Para almacenar el ID del intervalo de refresco
        let clockInterval = null; // Para almacenar el ID del intervalo del reloj

        // Global variable for pressure history
        window.appPressureHistory = [];
        const MAX_PRESSURE_HISTORY_POINTS = 20; // Keep up to 20 points in history

        // --- STARTUP ---
        window.onload = () => {
            loadFishMenu();
            calculateMoonPhase(); // Llamar aqu√≠ para asegurar que los elementos existan
            initApp(); 
            initCompass();
            renderLog();
            updateClock(); // Initial call to display time immediately
            clockInterval = setInterval(updateClock, 1000); // Update clock every second
        };

        // --- CORE DATA LOGIC ---
        function forceReload() {
            document.getElementById('loc-name').innerHTML = "Reiniciando...";
            if (dataRefreshInterval) clearInterval(dataRefreshInterval); // Limpiar el intervalo existente
            initApp();
        }

        function initApp() {
            const fallbackLat = -34.6037;
            const fallbackLon = -58.3816;

            if(!navigator.geolocation) {
                alert("Navegador sin soporte GPS. Usando ubicaci√≥n de respaldo.");
                fetchData(fallbackLat, fallbackLon, false);
                return;
            }

            const gpsOptions = { timeout: 8000, enableHighAccuracy: true };
            const safetyTimeout = setTimeout(() => {
                console.warn("GPS tard√≥ mucho. Usando ubicaci√≥n de respaldo.");
                document.getElementById('gps-status').innerText = "Tiempo agotado. Modo Respaldo.";
                fetchData(fallbackLat, fallbackLon, false);
            }, 9000);

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    clearTimeout(safetyTimeout);
                    fetchData(pos.coords.latitude, pos.coords.longitude, true);
                    // Establecer un intervalo para actualizar los datos cada 5 minutos (300000 ms)
                    if (dataRefreshInterval) clearInterval(dataRefreshInterval);
                    dataRefreshInterval = setInterval(() => fetchData(pos.coords.latitude, pos.coords.longitude, true), 300000);
                }, 
                (err) => {
                    clearTimeout(safetyTimeout);
                    console.error("GPS Fall√≥:", err.message);
                    document.getElementById('gps-status').innerText = `üî¥ GPS FALLO: ${err.message}`;
                    document.getElementById('gps-status').style.color = "var(--danger)";
                    // Asegurar que los datos del clima se reseteen tambi√©n
                    document.getElementById('temp').innerText = "--¬∞";
                    document.getElementById('feels-like').innerText = "ST: --¬∞";
                    document.getElementById('wind-speed').innerText = "--";
                    document.getElementById('wind-dir').innerText = "--";
                    document.getElementById('press').innerText = "--";
                    document.getElementById('press-desc').innerText = "Sin Datos";
                    document.getElementById('humidity-val').innerText = '--%';
                    document.getElementById('clouds-val').innerText = '--%';
                    document.getElementById('sunrise-time').innerText = '--:--';
                    document.getElementById('sunset-time').innerText = '--:--';
                    // Nota: 'tide-current' y 'tide-next' ahora son para la fase lunar, no para mareas. 
                    // No hay impacto directo en estos campos por fallo de GPS, excepto si sus datos 
                    // se obtuvieran de una API que tambi√©n fallara.
                    // Se re-establecen a un estado consistente para mostrar ausencia de datos de marea.
                    // Esto es solo para ser consistente si en el futuro se volviera a tener mareas
                    // o para evitar errores si el script de mareas intentara acceder a ellos.
                    // Para la fase lunar, no es necesario resetearlos aqu√≠ directamente.
                    fetchData(fallbackLat, fallbackLon, false);
                    // Establecer un intervalo para el modo demo (si aplica)
                    if (dataRefreshInterval) clearInterval(dataRefreshInterval);
                    dataRefreshInterval = setInterval(() => fetchData(fallbackLat, fallbackLon, false), 300000);
                }, 
                gpsOptions
            );
        }

        function fetchData(lat, lon, isReal) {
            document.getElementById('gps-status').innerText = isReal ? "üü¢ GPS ACTIVO" : "üî¥ MODO DEMO (SIN GPS)";
            document.getElementById('gps-status').style.color = isReal ? "var(--green)" : "var(--danger)";

            if(isReal) {
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                .then(r=>r.json())
                .then(d => {
                    document.getElementById('loc-name').innerText = "üìç " + (d.address.city || d.address.town || d.address.village || "Zona Detectada");
                }).catch((e)=> {
                    console.error("Error al obtener nombre de ubicaci√≥n:", e);
                    document.getElementById('loc-name').innerText = "üìç Zona de Pesca (Nombre no disponible)";
                });
            } else {
                document.getElementById('loc-name').innerText = "üìç Buenos Aires (Defecto)";
            }

            determineSpecies(lat, lon);

            // API CLIMA (SOLUCI√ìN: Par√°metros de presi√≥n corregidos para MSL)
            // Agregamos relative_humidity_2m, cloud_cover para 'current'
            // Y sunrise, sunset para 'daily'
            const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,pressure_msl,surface_pressure,wind_speed_10m,wind_direction_10m,relative_humidity_2m,cloud_cover&daily=sunrise,sunset&timezone=auto`;

            fetch(weatherUrl)
                .then(r => {
                    if (!r.ok) {
                        throw new Error(`HTTP error! status: ${r.status}`);
                    }
                    return r.json();
                })
                .then(data => {
                console.log("Open-Meteo API Response (Clima/Ambiente):", data); // Log de la respuesta completa de la API

                // Asegura que cur y daily sean objetos para evitar errores al acceder a propiedades
                const cur = data.current || {};
                const daily = data.daily || {};

                // Temp
                document.getElementById('temp').innerText = cur?.temperature_2m !== undefined && cur?.temperature_2m !== null ? `${Math.round(cur.temperature_2m)}¬∞` : '--¬∞';
                document.getElementById('feels-like').innerText = cur?.apparent_temperature !== undefined && cur?.apparent_temperature !== null ? `ST: ${Math.round(cur.apparent_temperature)}¬∞` : 'ST: --¬∞';

                // Viento
                document.getElementById('wind-speed').innerText = cur?.wind_speed_10m !== undefined && cur?.wind_speed_10m !== null ? Math.round(cur.wind_speed_10m).toString() : '--';
                let wDir = cur?.wind_direction_10m; 
                if (wDir !== undefined && wDir !== null) {
                    const dirs = ['NORTE', 'NE', 'ESTE', 'SE', 'SUR', 'SO', 'OESTE', 'NO'];
                    const dirIndex = Math.round(((wDir %= 360) < 0 ? wDir + 360 : wDir) / 45) % 8;
                    document.getElementById('wind-dir').innerText = "DEL " + dirs[dirIndex];
                } else {
                    document.getElementById('wind-dir').innerText = '--';
                }

                // Presi√≥n HPA (Ahora manejado aqu√≠ con datos reales)
                const pressureHPA = cur?.pressure_msl;
                const pressElement = document.getElementById('press');
                const pDescElement = document.getElementById('press-desc');

                if (pressElement && pDescElement && pressureHPA !== undefined && pressureHPA !== null) {
                    pressElement.innerText = Math.round(pressureHPA).toString();
                    let descText; 
                    let descColor; 
                    if (pressureHPA <= 1009) {
                        descText = "BAJA";
                        descColor = "var(--danger)";
                    } else if (pressureHPA >= 1016) {
                        descText = "ALTA";
                        descColor = "var(--green)";
                    } else {
                        descText = "ESTABLE";
                        descColor = "#aaa";
                    }
                    pDescElement.innerText = descText;
                    pDescElement.style.color = descColor;

                    // Update global pressure history and notify React
                    window.appPressureHistory.push({
                        time: new Date().toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' }),
                        hpa: Math.round(pressureHPA)
                    });
                    if (window.appPressureHistory.length > MAX_PRESSURE_HISTORY_POINTS) {
                        window.appPressureHistory.shift(); // Remove oldest point
                    }
                    window.dispatchEvent(new CustomEvent('newPressureData'));

                } else {
                    if (pressElement) pressElement.innerText = "--";
                    if (pDescElement) pDescElement.innerText = "Sin Datos";
                }

                // Humedad
                const humidityVal = cur?.relative_humidity_2m;
                document.getElementById('humidity-val').innerText = (humidityVal !== undefined && humidityVal !== null) ? `${Math.round(humidityVal)}%` : '--%';
                if (humidityVal === undefined || humidityVal === null) console.warn("Humedad no disponible o es null en la respuesta de la API.");

                // Nubes
                const cloudsVal = cur?.cloud_cover;
                document.getElementById('clouds-val').innerText = (cloudsVal !== undefined && cloudsVal !== null) ? `${Math.round(cloudsVal)}%` : '--%';
                if (cloudsVal === undefined || cloudsVal === null) console.warn("Cobertura de nubes no disponible o es null en la respuesta de la API.");

                // Amanecer y Atardecer
                if (daily?.sunrise?.[0] && daily?.sunset?.[0]) { // Comprobaci√≥n m√°s robusta
                    const sunriseTime = new Date(daily.sunrise[0]).toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
                    const sunsetTime = new Date(daily.sunset[0]).toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' });
                    document.getElementById('sunrise-time').innerText = sunriseTime;
                    document.getElementById('sunset-time').innerText = sunsetTime;
                } else {
                    document.getElementById('sunrise-time').innerText = '--:--';
                    document.getElementById('sunset-time').innerText = '--:--';
                    console.warn("Datos de amanecer/atardecer no disponibles o est√°n vac√≠os en la respuesta de la API.");
                }

                console.log("UI actualizada para humedad, nubes, amanecer, atardecer.");

            }).catch(e => {
                console.error("API Error (Clima/Ambiente):", e);
                // Asegura que todos los campos relevantes muestren "Sin Datos" o "--" en caso de error de la API
                document.getElementById('temp').innerText = "--¬∞";
                document.getElementById('feels-like').innerText = "ST: --¬∞";
                document.getElementById('wind-speed').innerText = "--";
                document.getElementById('wind-dir').innerText = "--";
                document.getElementById('press').innerText = "--";
                document.getElementById('press-desc').innerText = "Sin Datos";
                document.getElementById('humidity-val').innerText = '--%';
                document.getElementById('clouds-val').innerText = '--%';
                document.getElementById('sunrise-time').innerText = '--:--';
                document.getElementById('sunset-time').innerText = '--:--';
            });

            // MAREAS (se ha eliminado este fetch, por lo tanto, no se muestran datos de mareas)
            // La fase lunar se calcula localmente, no depende de una API externa aqu√≠.
        }

        // --- C√ÅLCULO LUNAR ---
        function calculateMoonPhase() {
            const date = new Date();
            const lp = 2551443; 
            const new_moon = new Date(1970, 0, 7, 20, 35, 0);
            const phase_total = ((date.getTime() - new_moon.getTime()) / 1000) % lp;
            const phase_days = Math.floor(phase_total / (24 * 3600)) + 1;
            
            let phase = "Nueva", icon = "üåë";
            if (phase_days >= 2 && phase_days < 8) { phase = "Creciente"; icon = "üåí"; }
            else if (phase_days >= 8 && phase_days < 10) { phase = "Cuarto Crec."; icon = "üåì"; }
            else if (phase_days >= 10 && phase_days < 14) { phase = "Gibosa"; icon = "üåî"; }
            else if (phase_days >= 14 && phase_days < 16) { phase = "LLENA"; icon = "üåï"; }
            else if (phase_days >= 16 && phase_days < 22) { phase = "Menguante"; icon = "üåñ"; }
            else if (phase_days >= 22 && phase_days < 24) { phase = "Cuarto Meng."; icon = "üåó"; }
            else if (phase_days >= 24) { phase = "Menguante"; icon = "üåò"; }
            
            const moonPhaseElement = document.getElementById('moon-phase');
            const moonIconElement = document.getElementById('moon-icon');

            if (moonPhaseElement && moonIconElement) {
                moonPhaseElement.innerText = phase.toUpperCase();
                moonIconElement.innerText = icon;
            } else {
                console.warn("Elementos de fase lunar no encontrados para actualizar. Aseg√∫rate de que los IDs 'moon-phase' y 'moon-icon' existan en el DOM.");
            }
        }

        function determineSpecies(lat, lon) {
            const box = document.getElementById('bio-box');
            const regionLbl = document.getElementById('bio-region');
            const speciesLbl = document.getElementById('bio-species');
            box.style.display = 'block';
            
            if (lat > -35 && lat < -33 && lon > -60 && lon < -57) {
                regionLbl.innerText = "DELTA / R√çO DE LA PLATA";
                speciesLbl.innerText = "Dorado, Boga, Tararira, Bagre, Surub√≠.";
            } else if (lat <= -36 && lat > -42 && lon > -60) {
                regionLbl.innerText = "COSTA ATL√ÅNTICA";
                speciesLbl.innerText = "Corvina, Pescadilla, Lenguado, Pejerrey.";
            } else if (lat > -33 && lat < -25 && lon > -60) {
                regionLbl.innerText = "LITORAL / PARAN√Å";
                speciesLbl.innerText = "Dorado, Surub√≠, Pac√∫, Manguruy√∫.";
            } else if (lat <= -39 && lon < -65) {
                regionLbl.innerText = "PATAGONIA";
                speciesLbl.innerText = "Trucha Arco√≠ris, Marr√≥n, Salm√≥n.";
            } else {
                regionLbl.innerText = "ZONA GENERAL";
                speciesLbl.innerText = "Variada local. Verifique reglamentaci√≥n.";
            }
        }

        // --- COMPASS ---
        function requestCompassPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                .then(r => { if (r==='granted') initCompass(); else alert("Permiso denegado"); })
                .catch(console.error);
            } else {
                alert("Br√∫jula activa. Si no gira, gire el celular.");
            }
        }
        function initCompass() {
            if (window.DeviceOrientationEvent) {
                window.addEventListener("deviceorientation", function(e) {
                    let h = e.alpha; 
                    if(h !== null) { document.getElementById('compass-needle').style.transform = `translate(-50%, -50%) rotate(${360 - h}deg)`; }
                }, true);
            }
        }

        // --- RELOJ ANAL√ìGICO ---
        function updateClock() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();

            const secondHand = document.getElementById('second-hand');
            const minuteHand = document.getElementById('minute-hand');
            const hourHand = document.getElementById('hour-hand');

            if (secondHand && minuteHand && hourHand) {
                // Calculate rotation for each hand
                // Seconds: 360 degrees / 60 seconds = 6 degrees per second
                const secondsDegrees = (seconds / 60) * 360;
                // Minutes: 360 degrees / 60 minutes = 6 degrees per minute. Add (seconds / 60) * 6 degrees for smooth movement.
                const minutesDegrees = ((minutes + seconds / 60) / 60) * 360;
                // Hours: 360 degrees / 12 hours = 30 degrees per hour. Add (minutes / 60) * 30 degrees for smooth movement.
                const hoursDegrees = ((hours % 12 + minutes / 60) / 12) * 360;

                secondHand.style.transform = `translateX(-50%) rotate(${secondsDegrees}deg)`;
                minuteHand.style.transform = `translateX(-50%) rotate(${minutesDegrees}deg)`;
                hourHand.style.transform = `translateX(-50%) rotate(${hoursDegrees}deg)`;
            }
        }

        // --- UI ---
        function switchTab(m){ currentMode=m; document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); event.target.classList.add('active'); loadFishMenu(); }
        function loadFishMenu(){ const s=document.getElementById('fish-selector'); s.innerHTML='<option>Selecciona pez...</option>'; fishDB[currentMode].forEach((f,i)=>{const o=document.createElement('option'); o.value=i; o.innerText=f.n; s.appendChild(o)}); document.getElementById('fish-info').classList.remove('show'); }
        function showFishInfo(){ const i=document.getElementById('fish-selector').value; if(!i)return; const f=fishDB[currentMode][i]; document.getElementById('fish-hook').innerText=f.h; document.getElementById('fish-bait').innerText=f.b; document.getElementById('fish-tip').innerText=f.t; document.getElementById('fish-info').classList.add('show'); }
        
        async function toggleFlash(){ 
            const b=document.getElementById('btn-torch'); 
            if(torchTrack){torchTrack.stop(); torchTrack=null; b.classList.remove('on'); return;} 
            try{ 
                const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}); 
                torchTrack=s.getVideoTracks()[0]; 
                await torchTrack.applyConstraints({advanced:[{torch:true}]}); 
                b.classList.add('on'); 
            }catch(e){alert("Error: Flash requiere permiso de c√°mara/HTTPS.");} 
        }

        // --- LOCALSTORAGE ---
        function saveQuickLog() {
            const text = prompt("üìù Captura (Especie - Kg):");
            if(text) {
                const now = new Date();
                const dStr = now.getDate() + "/" + (now.getMonth()+1) + " " + now.getHours() + ":" + (now.getMinutes()<10?'0':'')+now.getMinutes();
                const item = { id: Date.now(), text: text, date: dStr };
                let h = JSON.parse(localStorage.getItem('pescaLog')) || [];
                h.unshift(item);
                localStorage.setItem('pescaLog', JSON.stringify(h));
                renderLog();
            }
        }
        function renderLog() {
            const c = document.getElementById('log-history');
            const h = JSON.parse(localStorage.getItem('pescaLog')) || [];
            if (h.length === 0) { c.innerHTML = '<div style="text-align:center; color:#666; font-size:1rem; padding:10px;">Sin historial</div>'; return; }
            let html = "";
            h.forEach(i => {
                html += `<div class="log-item"><div><span class="log-text">${i.text}</span><span class="log-date">${i.date}</span></div><button class="btn-delete" onclick="deleteLog(${i.id})">√ó</button></div>`;
            });
            c.innerHTML = html;
        }
        function deleteLog(id) {
            if(confirm("¬øBorrar?")) {
                let h = JSON.parse(localStorage.getItem('pescaLog')) || [];
                h = h.filter(i => i.id !== id);
                localStorage.setItem('pescaLog', JSON.stringify(h));
                renderLog();
            }
        }
    </script>
    <script type="module" src="/index.tsx"></script>
</body>
</html>