<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOLA Pesca - Tactical Ops</title>
    <style>
        /* --- FUENTE TACTICAL --- */
        @font-face {
            font-family: 'PitchedBattle';
            src: url('https://raw.githubusercontent.com/LOLAPALUPULO/LOLA-Pesca/main/Pitched%20Battle.ttf') format('truetype');
        }

        :root {
            --bg: #0b1120;
            --card: #1e293b;
            --text: #f1f5f9;
            --blue: #38bdf8;
            --green: #4ade80;
            --yellow: #facc15;
            --orange: #fb923c;
            --danger: #ef4444;
            --font-title: 'PitchedBattle', sans-serif;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 12px;
            padding-bottom: 100px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- LOGO --- */
        .brand-header {
            text-align: center;
            padding: 10px 0;
            display: flex;
            justify-content: center;
        }
        .brand-link { width: 60%; display: block; }
        .brand-logo {
            width: 100%; 
            height: auto;
            filter: drop-shadow(0 0 15px rgba(0,0,0,0.6));
        }

        /* --- CONTENEDORES --- */
        .card-box {
            background: var(--card);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
            text-align: center;
            position: relative;
        }

        /* --- TEXTOS --- */
        .lbl { 
            font-family: var(--font-title); 
            color: #94a3b8; 
            font-size: 0.9rem; 
            margin-bottom: 5px; 
            letter-spacing: 1px; 
            text-transform: uppercase; 
        }
        
        .val { 
            font-size: 2.4rem; 
            font-weight: 900; 
            margin-top: 2px; 
            line-height: 1; 
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .sub-val { 
            font-size: 1rem; 
            color: #cbd5e1; 
            margin-top: 6px; 
            font-weight: 600;
        }

        .section-header { 
            text-align: center; color: var(--blue); font-family: var(--font-title); 
            margin: 30px 0 15px 0; font-size: 1.4rem; letter-spacing: 1px; 
            border-bottom: 2px solid #334155; padding-bottom: 8px;
        }
        
        /* HEADER UBICACI√ìN */
        .location-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 6px solid var(--blue);
            text-align: left;
            padding: 15px;
            background: #151e2e;
        }
        .loc-title { font-size: 1.4rem; color: white; margin-bottom: 2px; font-weight:bold; font-family: var(--font-title); }
        .loc-sub { font-size: 0.8rem; color: var(--yellow); }

        /* --- GRILLAS --- */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px; }

        .data-box {
            background: var(--card);
            padding: 15px 5px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 110px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* --- MAREAS --- */
        .tide-box {
            background: linear-gradient(160deg, #1e3a8a 0%, #0f172a 100%);
            border: 1px solid #3b82f6;
        }
        .tide-main { font-size: 1.7rem; font-weight: bold; color: white; margin: 5px 0; }
        .tide-sub { font-size: 0.9rem; background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2); }

        /* --- BR√öJULA --- */
        .compass-container { cursor: pointer; } 
        .compass-rose {
            width: 70px; height: 70px; border-radius: 50%;
            background: #0f172a; border: 3px solid #475569;
            position: relative; box-shadow: inset 0 0 10px #000;
        }
        .cardinal { position: absolute; font-size: 0.75rem; font-weight: bold; color: #64748b; }
        .c-n { top: 2px; left: 50%; transform: translateX(-50%); color: var(--danger); }
        .c-s { bottom: 2px; left: 50%; transform: translateX(-50%); }
        .c-e { right: 4px; top: 50%; transform: translateY(-50%); }
        .c-o { left: 4px; top: 50%; transform: translateY(-50%); }

        .compass-needle {
            position: absolute; top: 50%; left: 50%;
            width: 8px; height: 50px;
            background: linear-gradient(to bottom, var(--danger) 50%, white 50%);
            transform: translate(-50%, -50%) rotate(0deg);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 5px rgba(0,0,0,0.8);
            z-index: 10;
        }

        /* --- GUIA PECES --- */
        .guide-container { padding: 15px; }
        .tabs { display: flex; margin-bottom: 15px; border-bottom: 2px solid #334155; }
        .tab { 
            flex: 1; padding: 15px; text-align: center; background: none; border: none; 
            color: #64748b; font-size: 1.2rem; cursor: pointer; font-family: var(--font-title); 
        }
        .tab.active { color: var(--blue); border-bottom: 3px solid var(--blue); color: white; }
        
        select { 
            width: 100%; padding: 15px; background: #0f172a; border: 1px solid #334155; 
            color: white; border-radius: 8px; font-size: 1.2rem;
        }

        .fish-details { margin-top: 15px; display: none; padding: 15px; background: #111827; border-radius: 10px; border: 1px solid #374151; }
        .fish-details.show { display: block; animation: fadeIn 0.3s; }
        .detail-item { margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .detail-item:last-child { border: none; }

        /* --- PREDICCION ESPECIES --- */
        .prediction-box { background: rgba(56, 189, 248, 0.1); border: 1px solid #334155; text-align: left; padding: 15px; display: none; }
        .species-list { font-size: 1.1rem; color: white; font-weight: 500; margin-top: 8px; line-height: 1.4; }
        .biome-tag { font-size: 0.9rem; background: var(--blue); color: #000; padding: 4px 8px; border-radius: 4px; font-weight: bold; }

        /* --- BOTONES --- */
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px;}
        .btn-action {
            padding: 22px; border: none; border-radius: 12px; color: white;
            display: flex; align-items: center; justify-content: center; gap: 10px; 
            font-size: 1.2rem; cursor: pointer; font-family: var(--font-title);
            box-shadow: 0 4px 0 rgba(0,0,0,0.3); transition: transform 0.1s;
        }
        .btn-action:active { transform: translateY(4px); box-shadow: none; }
        .btn-torch { background: #475569; }
        .btn-torch.on { background: #f1f5f9; color: black; box-shadow: 0 0 20px white; }
        .btn-log { background: var(--green); color: #064e3b; }

        /* --- BITACORA --- */
        .log-container { margin-top: 30px; border-top: 2px solid #334155; padding-top: 15px; }
        .log-item {
            background: #1e293b; border-left: 5px solid var(--green);
            padding: 12px; margin-bottom: 10px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center; 
        }
        .log-text { font-size: 1rem; color: white; font-weight: bold; }
        .log-date { font-size: 0.85rem; color: #94a3b8; display: block; margin-top: 4px; }
        .btn-delete { background: #450a0a; border-radius: 6px; color: var(--danger); font-size: 1.3rem; width: 40px; height: 40px; border: none; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <!-- 1. LOGO -->
    <div class="brand-header">
        <a href="https://www.instagram.com/lolapalupulo/" target="_blank" class="brand-link">
            <img src="https://raw.githubusercontent.com/LOLAPALUPULO/LOLA-Pesca/refs/heads/main/lolapesca.svg" alt="Lola Pesca" class="brand-logo">
        </a>
    </div>

    <!-- 2. UBICACI√ìN -->
    <div class="card-box location-bar">
        <div>
            <div class="loc-title" id="loc-name">üìç Buscando GPS...</div>
            <div class="loc-sub" id="status-msg">Estableciendo conexi√≥n...</div>
        </div>
        <button onclick="window.location.reload()" style="background:none; border:none; font-size:2.5rem; cursor:pointer;">üîÑ</button>
    </div>

    <!-- 3. NIVEL CR√çTICO (Viento / Br√∫jula / Agua) -->
    <div class="grid-3">
        <div class="data-box">
            <span class="lbl">VIENTO</span>
            <span class="val" id="wind-speed">--</span>
            <div class="sub-val" id="wind-dir" style="color: var(--blue); font-weight:bold;">--</div>
        </div>
        <div class="data-box compass-container" onclick="requestCompassPermission()">
            <div class="compass-rose">
                <span class="cardinal c-n">N</span>
                <span class="cardinal c-e">E</span>
                <span class="cardinal c-s">S</span>
                <span class="cardinal c-o">O</span>
                <div class="compass-needle" id="compass-needle"></div>
            </div>
            <div style="font-size:0.6rem; margin-top:8px; color:#888; font-weight:bold;">BR√öJULA</div>
        </div>
        <div class="data-box tide-box">
            <div class="lbl" style="color:#bfdbfe">AGUA</div>
            <div class="tide-main" id="tide-current" style="font-size:1.6rem;">--</div>
            <div class="tide-sub" id="tide-next">--</div>
        </div>
    </div>

    <!-- 4. PRESI√ìN Y LUNA -->
    <div class="grid-2">
        <div class="data-box">
            <span class="lbl">PRESI√ìN (hPa)</span>
            <span class="val" id="press">--</span>
            <span class="sub-val" id="press-desc" style="font-weight:bold">Esperando datos..</span>
        </div>
        <div class="data-box" style="justify-content: space-between;">
            <span class="lbl">FASE LUNAR</span>
            <div style="font-size:2rem; margin:0;" id="moon-icon">üåë</div>
            <span style="font-weight:bold; font-size:0.9rem; color:white;" id="moon-phase">--</span>
        </div>
    </div>
    
    <!-- 5. TEMP Y UV -->
    <div class="grid-2">
        <div class="data-box">
            <span class="lbl">TEMP</span>
            <span class="val" id="temp">--¬∞</span>
            <div class="sub-val" id="feels-like">ST: --¬∞</div>
        </div>
        <div class="data-box" style="border: 1px solid #334155;">
            <span class="lbl">INDICE UV MAX</span>
            <span class="val" id="uv-val">--</span>
            <div style="height:6px; width:80%; background:#333; margin-top:8px; border-radius:3px;">
                <div id="uv-bar" style="height:100%; width:0%; background:var(--green); border-radius:3px; transition:1s;"></div>
            </div>
            <div class="sub-val" id="uv-msg">--</div>
        </div>
    </div>

    <!-- 6. CONSULTAS -->
    <div class="section-header">ENCICLOPEDIA T√ÅCTICA</div>
    
    <div class="card-box prediction-box" id="bio-box">
        <span class="biome-tag" id="bio-region">ZONA...</span>
        <div class="lbl" style="margin-top:10px;">ESPECIES PREDOMINANTES:</div>
        <div class="species-list" id="bio-species">--</div>
    </div>

    <div class="card-box guide-container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('rio')">R√çO</button>
            <button class="tab" onclick="switchTab('mar')">MAR</button>
        </div>
        <select id="fish-selector" onchange="showFishInfo()">
            <!-- JS -->
        </select>
        <div id="fish-info" class="fish-details">
            <div class="detail-item">
                <div class="lbl">ANZUELO</div>
                <div id="fish-hook" style="font-size:1.2rem; color:var(--blue); font-weight:bold;">--</div>
            </div>
            <div class="detail-item">
                <div class="lbl">CARNADA</div>
                <div id="fish-bait" style="font-size:1.2rem;">--</div>
            </div>
            <div class="detail-item">
                <div class="lbl">CONSEJO</div>
                <div id="fish-tip" style="font-size:1.1rem; color:var(--orange); font-style:italic;">--</div>
            </div>
        </div>
    </div>

    <!-- 7. HERRAMIENTAS -->
    <div class="action-grid">
        <button id="btn-torch" class="btn-action btn-torch" onclick="toggleFlash()">
            üí° LINTERNA
        </button>
        <button class="btn-action btn-log" onclick="saveQuickLog()">
            üìù BIT√ÅCORA
        </button>
    </div>

    <div id="log-history" class="log-container">
        <div style="text-align:center; color:#666; font-size:1rem; padding:10px;">Cargando historial...</div>
    </div>

    <script>
        // --- BASE DE DATOS LOCAL ---
        const fishDB = {
            rio: [
                {n:"Dorado", h:"5/0 a 8/0 Pata Larga", b:"Anguila, Morena", t:"Usa l√≠der de acero 40lbs."},
                {n:"Surub√≠", h:"8/0 a 10/0", b:"Morena, Anguila", t:"Busca pozos profundos de noche."},
                {n:"Boga", h:"Simple chico (1 o 2)", b:"Ma√≠z, Masa, Salam√≠n", t:"Clava cuando corre, boca dura."},
                {n:"Pejerrey", h:"Peque√±o (4 o 5)", b:"Mojarra viva, Filet", t:"Usa boyas y regula profundidad."},
                {n:"Tararira", h:"Offset / Triple", b:"Rana goma, Dientudo", t:"Activa con calor, busca yuyos."},
                {n:"Bagre (Moncholo)", h:"3/0 Com√∫n", b:"Lombriz, Tripa", t:"Pesca de fondo en remansos."}
            ],
            mar: [
                {n:"Corvina Rubia", h:"3/0 a 5/0", b:"Langostino, Anchoa", t:"Lanza a la 2da canaleta."},
                {n:"Lenguado", h:"Triple robador", b:"Pejerrey entero", t:"Recogida muy lenta por fondo."},
                {n:"Pescadilla", h:"2/0 a 3/0", b:"Camar√≥n, Filet", t:"Pica firme, usa destrabe."},
                {n:"Pejerrey Mar", h:"Largo y fino", b:"Camar√≥n, Filet", t:"L√≠nea de 3 boyas o paternoster."},
                {n:"Chucho / Raya", h:"6/0 Fuerte", b:"Anchoa, Calamar", t:"Pelea pegado al fondo."}
            ]
        };

        let currentMode = 'rio';
        let torchTrack = null;

        // --- INICIO ---
        window.onload = () => {
            loadFishMenu();
            calculateMoonPhase();
            initApp(); 
            initCompass();
            renderLog();
        };

        // --- LOGICA DE DATOS BLINDADA ---
        function initApp() {
            // Ubicaci√≥n Fallback: Buenos Aires (Costanera)
            const fallbackLat = -34.55;
            const fallbackLon = -58.4;

            if(!navigator.geolocation) {
                alert("Navegador sin GPS. Se usar√° ubicaci√≥n de respaldo.");
                fetchData(fallbackLat, fallbackLon, false);
                return;
            }

            // Opciones de GPS m√°s agresivas
            const gpsOptions = { timeout: 8000, maximumAge: 60000 };
            
            // Timeout manual de seguridad (Si el GPS del navegador no responde nunca)
            const safetyTimeout = setTimeout(() => {
                console.warn("GPS tard√≥ mucho.");
                document.getElementById('status-msg').innerText = "Tiempo de espera agotado. Usando respaldo.";
                fetchData(fallbackLat, fallbackLon, false);
            }, 9000);

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    clearTimeout(safetyTimeout);
                    fetchData(pos.coords.latitude, pos.coords.longitude, true);
                }, 
                (err) => {
                    clearTimeout(safetyTimeout);
                    console.warn("GPS Fall√≥:", err.message);
                    fetchData(fallbackLat, fallbackLon, false);
                }, 
                gpsOptions
            );
        }

        function fetchData(lat, lon, isReal) {
            // Actualizar status visual
            const statusDiv = document.getElementById('status-msg');
            statusDiv.innerText = isReal ? "üì° GPS CONECTADO - DATOS EN TIEMPO REAL" : "‚ö†Ô∏è MODO DEMO / GPS FALL√ì (Zona: BSAS)";
            statusDiv.style.color = isReal ? "var(--green)" : "var(--danger)";

            // 1. Ciudad (Nominatim)
            if (isReal) {
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                .then(r => r.json())
                .then(d => {
                    document.getElementById('loc-name').innerText = "üìç " + (d.address.city || d.address.town || d.address.village || "Costa/R√≠o");
                })
                .catch(() => { document.getElementById('loc-name').innerText = "üìç Zona de Pesca"; });
            } else {
                document.getElementById('loc-name').innerText = "üìç R√≠o de la Plata (Demo)";
            }

            // Analisis de Especies
            determineSpecies(lat, lon);

            // 2. CLIMA + PRESI√ìN + UV (Open-Meteo V1)
            // SOLUCION UV: Pedimos uv_index_max (diario) en vez de uv_index (horario)
            const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,pressure_msl,surface_pressure,wind_speed_10m,wind_direction_10m,weather_code&daily=uv_index_max&timezone=auto`;

            fetch(weatherUrl).then(r => r.json()).then(data => {
                const cur = data.current;
                
                // Temp
                document.getElementById('temp').innerText = Math.round(cur.temperature_2m) + "¬∞";
                document.getElementById('feels-like').innerText = "ST: " + Math.round(cur.apparent_temperature) + "¬∞";

                // Viento
                document.getElementById('wind-speed').innerText = Math.round(cur.wind_speed_10m);
                const wDir = cur.wind_direction_10m;
                const dirs = ['NORTE', 'NE', 'ESTE', 'SE', 'SUR', 'SO', 'OESTE', 'NO'];
                const dirIndex = Math.round(((wDir %= 360) < 0 ? wDir + 360 : wDir) / 45) % 8;
                document.getElementById('wind-dir').innerText = "DEL " + dirs[dirIndex];

                // PRESI√ìN (FALLBACK INTELIGENTE)
                // Intenta Presi√≥n Nivel Mar (Mejor), si falla, usa Superficie.
                let p = cur.pressure_msl;
                if (!p) p = cur.surface_pressure; 
                
                if (p) {
                    const pVal = Math.round(p);
                    document.getElementById('press').innerText = pVal;
                    
                    const pDesc = document.getElementById('press-desc');
                    if(pVal < 1008) { 
                        pDesc.innerText = "‚¨á BAJA (Pez lento)"; pDesc.style.color = "var(--danger)"; 
                    } else if(pVal > 1018) { 
                        pDesc.innerText = "‚¨Ü ALTA (Activo)"; pDesc.style.color = "var(--green)"; 
                    } else { 
                        pDesc.innerText = "‚û° ESTABLE"; pDesc.style.color = "#aaa"; 
                    }
                } else {
                    document.getElementById('press').innerText = "N/A";
                }

                // UV MAXIMO DIARIO (Seguro)
                let uvMax = 0;
                if (data.daily && data.daily.uv_index_max && data.daily.uv_index_max.length > 0) {
                    uvMax = data.daily.uv_index_max[0];
                }
                
                document.getElementById('uv-val').innerText = uvMax;
                const uvBar = document.getElementById('uv-bar');
                const uvMsg = document.getElementById('uv-msg');
                
                let color = "var(--green)", width = "20%", msg = "BAJO";
                if(uvMax >= 3) { color = "var(--yellow)"; width = "50%"; msg = "MODERADO"; }
                if(uvMax >= 6) { color = "var(--orange)"; width = "80%"; msg = "ALTO (Gorro)"; }
                if(uvMax >= 8) { color = "var(--danger)"; width = "100%"; msg = "EXTREMO"; }
                
                uvBar.style.background = color;
                uvBar.style.width = width;
                uvMsg.innerText = msg;
                uvMsg.style.color = color;

            }).catch(e => {
                console.error("API CLIMA ERROR:", e);
                document.getElementById('press-desc').innerText = "Error conexi√≥n";
            });

            // 3. MAREAS (API Marina)
            const marineUrl = `https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lon}&hourly=tide_height&timezone=auto`;
            fetch(marineUrl).then(r => r.json()).then(data => {
                if(!data.hourly || !data.hourly.tide_height) throw new Error("Sin Mareas");
                
                const now = new Date();
                const h = now.getHours();
                const tides = data.hourly.tide_height.slice(h, h+12);
                const times = data.hourly.time.slice(h, h+12);
                
                const trend = tides[1] > tides[0] ? "SUBIENDO ‚¨Ü" : "BAJANDO ‚¨á";
                document.getElementById('tide-current').innerText = trend;
                
                // Buscar pr√≥xima pleamar
                let maxVal = -99, maxTimeStr = "";
                for(let i=0; i<tides.length; i++) {
                    if(tides[i] > maxVal) { maxVal = tides[i]; maxTimeStr = times[i]; }
                }
                
                const d = new Date(maxTimeStr);
                const minFormatted = (d.getMinutes()<10?'0':'') + d.getMinutes();
                document.getElementById('tide-next').innerText = `Pleamar: ${d.getHours()}:${minFormatted} hs`;

            }).catch(() => {
                document.getElementById('tide-current').innerText = "R√çO/LAGO";
                document.getElementById('tide-next').innerText = "Sin marea oce√°nica";
            });
        }

        // --- CALCULO LUNAR ---
        function calculateMoonPhase() {
            const date = new Date();
            const lp = 2551443; 
            const new_moon = new Date(1970, 0, 7, 20, 35, 0);
            const phase_total = ((date.getTime() - new_moon.getTime()) / 1000) % lp;
            const phase_days = Math.floor(phase_total / (24 * 3600)) + 1;
            
            let phase = "Nueva", icon = "üåë";
            if (phase_days >= 2 && phase_days < 8) { phase = "Creciente"; icon = "üåí"; }
            else if (phase_days >= 8 && phase_days < 10) { phase = "Cuarto Crec."; icon = "üåì"; }
            else if (phase_days >= 10 && phase_days < 14) { phase = "Gibosa"; icon = "üåî"; }
            else if (phase_days >= 14 && phase_days < 16) { phase = "LLENA"; icon = "üåï"; }
            else if (phase_days >= 16 && phase_days < 22) { phase = "Menguante"; icon = "üåñ"; }
            else if (phase_days >= 22 && phase_days < 24) { phase = "Cuarto Meng."; icon = "üåó"; }
            else if (phase_days >= 24) { phase = "Menguante"; icon = "üåò"; }
            
            document.getElementById('moon-phase').innerText = phase.toUpperCase();
            document.getElementById('moon-icon').innerText = icon;
        }

        function determineSpecies(lat, lon) {
            const box = document.getElementById('bio-box');
            const regionLbl = document.getElementById('bio-region');
            const speciesLbl = document.getElementById('bio-species');
            box.style.display = 'block';
            
            if (lat > -35 && lat < -33 && lon > -60 && lon < -57) {
                regionLbl.innerText = "DELTA / R√çO DE LA PLATA";
                speciesLbl.innerText = "Dorado, Boga, Tararira, Bagre, Surub√≠.";
            } else if (lat <= -36 && lat > -42 && lon > -60) {
                regionLbl.innerText = "COSTA ATL√ÅNTICA";
                speciesLbl.innerText = "Corvina, Pescadilla, Lenguado, Pejerrey.";
            } else if (lat > -33 && lat < -25 && lon > -60) {
                regionLbl.innerText = "LITORAL / PARAN√Å";
                speciesLbl.innerText = "Dorado, Surub√≠, Pac√∫, Manguruy√∫.";
            } else if (lat <= -39 && lon < -65) {
                regionLbl.innerText = "PATAGONIA";
                speciesLbl.innerText = "Trucha Arco√≠ris, Marr√≥n, Salm√≥n.";
            } else {
                regionLbl.innerText = "ZONA GENERAL";
                speciesLbl.innerText = "Variada local. Verifique reglamentaci√≥n.";
            }
        }

        // --- COMPASS ---
        function requestCompassPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                .then(r => { if (r==='granted') initCompass(); else alert("Permiso denegado"); })
                .catch(console.error);
            } else {
                alert("Br√∫jula: Gira el celular para probar.");
            }
        }
        function initCompass() {
            if (window.DeviceOrientationEvent) {
                window.addEventListener("deviceorientation", function(e) {
                    let h = e.alpha; 
                    if(h !== null) { document.getElementById('compass-needle').style.transform = `translate(-50%, -50%) rotate(${360 - h}deg)`; }
                }, true);
            }
        }

        // --- UI ---
        function switchTab(m){ currentMode=m; document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); event.target.classList.add('active'); loadFishMenu(); }
        function loadFishMenu(){ const s=document.getElementById('fish-selector'); s.innerHTML='<option>Selecciona pez...</option>'; fishDB[currentMode].forEach((f,i)=>{const o=document.createElement('option'); o.value=i; o.innerText=f.n; s.appendChild(o)}); document.getElementById('fish-info').classList.remove('show'); }
        function showFishInfo(){ const i=document.getElementById('fish-selector').value; if(!i)return; const f=fishDB[currentMode][i]; document.getElementById('fish-hook').innerText=f.h; document.getElementById('fish-bait').innerText=f.b; document.getElementById('fish-tip').innerText=f.t; document.getElementById('fish-info').classList.add('show'); }
        
        async function toggleFlash(){ 
            const b=document.getElementById('btn-torch'); 
            if(torchTrack){torchTrack.stop(); torchTrack=null; b.classList.remove('on'); return;} 
            try{ 
                const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}); 
                torchTrack=s.getVideoTracks()[0]; 
                await torchTrack.applyConstraints({advanced:[{torch:true}]}); 
                b.classList.add('on'); 
            }catch(e){alert("Error: Flash requiere permiso de c√°mara/HTTPS.");} 
        }

        function saveQuickLog() {
            const text = prompt("üìù Captura (Especie - Kg):");
            if(text) {
                const now = new Date();
                const dStr = now.getDate() + "/" + (now.getMonth()+1) + " " + now.getHours() + ":" + (now.getMinutes()<10?'0':'')+now.getMinutes();
                const item = { id: Date.now(), text: text, date: dStr };
                let h = JSON.parse(localStorage.getItem('pescaLog')) || [];
                h.unshift(item);
                localStorage.setItem('pescaLog', JSON.stringify(h));
                renderLog();
            }
        }
        function renderLog() {
            const c = document.getElementById('log-history');
            const h = JSON.parse(localStorage.getItem('pescaLog')) || [];
            if (h.length === 0) { c.innerHTML = '<div style="text-align:center; color:#666; font-size:1rem; padding:10px;">Sin historial</div>'; return; }
            let html = "";
            h.forEach(i => {
                html += `<div class="log-item"><div><span class="log-text">${i.text}</span><span class="log-date">${i.date}</span></div><button class="btn-delete" onclick="deleteLog(${i.id})">√ó</button></div>`;
            });
            c.innerHTML = html;
        }
        function deleteLog(id) {
            if(confirm("¬øBorrar?")) {
                let h = JSON.parse(localStorage.getItem('pescaLog')) || [];
                h = h.filter(i => i.id !== id);
                localStorage.setItem('pescaLog', JSON.stringify(h));
                renderLog();
            }
        }
    </script>
</body>
</html>